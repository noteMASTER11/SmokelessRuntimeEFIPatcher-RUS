# WorkingProcess — порядок выполнения SREP в UEFI Shell

Документ описывает пошаговую последовательность действий `SmokelessRuntimeEFIPatcher.efi` при запуске из UEFI Shell, особенности работы со скриптами `.nsh`, а также способы включения расширенного DEBUG‑логирования.

## 1. Подготовка окружения
- Скомпилируйте утилиту (или возьмите готовый бинарник) и скопируйте его, конфигурационный файл `.cfg`, а также зависимости (`Oniguruma.efi`, дополнительные драйверы) на FAT32‑раздел.
- Убедитесь, что в корне раздела присутствует хотя бы один конфигурационный файл `*.cfg` — приложение выберет первый найденный.
- Для автоматического включения DEBUG‑лога заранее задайте один из вариантов:
  - переменная окружения `set SREP_DEBUG=1`;
  - аргумент командной строки `SmokelessRuntimeEFIPatcher.efi -d`;
  - любой из эквивалентных флагов `--debug`, `/d`.
- При необходимости зафиксируйте язык интерфейса: аргумент `ENG` переключит вывод на английский, при этом должна быть доступна запись в переменную `PlatformLang`.

## 2. Основной ход выполнения
1. **Старт и отключение watchdog**  
   Функция `SREPEntry` снимает системный watchdog, предотвращая неожиданный перезапуск во время долгих операций.
2. **Инициализация логгера**  
   `LoggerInit` анализирует аргументы и переменные окружения. Если обнаружен флаг DEBUG, логгер сразу включает файл `SREP_DEBUG.log` и отражает сообщения как в Shell, так и в лог.  
   Без флага утилита позже предложит вручную нажать `L` для включения логирования — в автоматизированных сценариях это сообщение лучше подавить, заранее активировав DEBUG.
3. **Получение HII ресурсов**  
   Приложение находит `HiiDatabase`, `HiiImage`, регистрирует языковые пакеты и подключает кастомный шрифт из `RussianFont.c`.
4. **Отрисовка заставки**  
   Через `GraphicsOutput` выводится логотип и приветствие, после чего задержка `1s` обеспечивает видимость экрана.
5. **Обработка аргументов Shell**  
   `CheckArgs` проверяет `ENG` и другие параметры, при необходимости меняет язык интерфейса и пишет статус в лог.
6. **Активация логирования (если требуется)**  
   Если DEBUG ещё не активирован, утилита ожидает несколько секунд нажатия `L`.  
   - Успех → вызывается `LoggerEnable`, сообщение `STR_DEBUG_ENABLED_MANUAL` печатается и записывается в лог.  
   - Отказ или таймаут → вывод `STR_LOG_CANCEL`, дальнейшая работа без файла.
7. **Загрузка и проверка Oniguruma**  
   Выполняется `LoadandRunImage("Oniguruma.efi")`, после чего ищется `EFI_REGULAR_EXPRESSION_PROTOCOL`. Ошибка фиксируется в лог, программа останавливается.
8. **Обход файловой системы**  
   Через `SimpleFileSystem->OpenVolume` перечисляются файлы, выбирается первый `.cfg`.  
   Все этапы (поиск, открытие) сопровождаются сообщениями `STR_CFG_*`.
9. **Чтение и парсинг конфигурации**  
   - Логгер фиксирует размер файла и подготовку данных.  
   - В `OpCode.c` список команд превращается в двусвязный список `OP_DATA`, поддерживающий добавление/удаление и переходы (в т.ч. `Skip`).  
   - Регулярные выражения применяются для поиска шаблонов при патчах.
10. **Выполнение очереди операций**  
    Для каждого `OP_DATA`:
    - Выводится заголовок (`PrintCase`).  
    - В зависимости от OPCODE вызываются функции загрузки образов, поиска шаблонов, патча, снятия протоколов.  
    - Каждый значимый шаг отражается в логах (`SREP_LOG_INFO/DEBUG`) с указанием параметров, адресов и результатов.
    - При ошибке выводится `STR_BREAKING_CAUSE`, после чего выполнение прерывается либо переходится к следующей операции (если так задумано модификатором).
11. **Завершение работы**  
    При успехе последние сообщения сообщают об итоговом статусе, после чего управление возвращается в Shell. Если логгер активен, файл `SREP_DEBUG.log` остаётся в том же каталоге.

## 3. Использование в `.nsh` скриптах
Минимальный шаблон:
```
@echo -off
set SREP_DEBUG=1
SmokelessRuntimeEFIPatcher.efi
if %lasterror% != 0 then
  echo SREP завершился с ошибкой %lasterror%
  pause
endif
```
- При запуске из скрипта ввод пользователя недоступен, поэтому рекомендуется заранее включать DEBUG‑лог либо добавлять аргумент `-d`.  
- Убедитесь, что `Oniguruma.efi` доступен в текущей директории или указаны корректные пути (используйте `cd` перед запуском).

## 4. Советы по отладке
- При сбоях просмотрите `SREP_DEBUG.log`: файл содержит все сообщения Shell и дополнительные DEBUG‑строки (например, дампы данных из `PrintDump`).
- Из Shell можно оперативно изменить маску уровней: `SmokelessRuntimeEFIPatcher.efi -d` включает DEBUG, а без флагов выводятся только важные события.
- Если лог не создаётся, проверьте:
  - корректность переменной `SREP_DEBUG`;
  - доступность `SimpleFileSystem` для загрузочного устройства;
  - наличие свободного места и прав на запись в раздел.
- Для последовательной консольной диагностики допускается перенаправление логов на COM‑порт (требует дополнительной интеграции `SerialPortLib` в код).

## 5. Связанные материалы
- Исходный код логгера — `SmokelessRuntimeEFIPatcher/Logger.c`, заголовок `Logger.h`.
- Основная точка входа и ключевая логика — `SmokelessRuntimeEFIPatcher/SmokelessRuntimeEFIPatcher.c`.
- Описание новых команд и синтаксиса — раздел «Добавленные команды» в `README.md`.


